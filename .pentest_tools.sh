#!/bin/bash

stealthshell() {
    echo "[*] Entering stealth mode shell..."

    # Disable shell history (detect shell)
    unset HISTFILE
    export HISTSIZE=0
    export HISTFILESIZE=0

    # Move to /tmp
    cd /tmp || exit 1

    if [ -n "$ZSH_VERSION" ]; then
        if setopt 2>&1 | grep -q history; then
            setopt NO_HISTORY
        fi
    elif [ -n "$BASH_VERSION" ]; then
        set +o history
    fi

    # Detect OS (Linux or macOS)
    if [[ "$(uname)" == "Linux" ]]; then
        BASE_PATH="/dev/shm"
    else
        BASE_PATH="/tmp"
    fi

    # Create a random RAM-based temp directory
    STEALTHDIR=$(mktemp -d "${BASE_PATH}/tmp.XXXXXX")
    cd "$STEALTHDIR" || exit 1

    echo "[*] Working inside $STEALTHDIR"
    echo "[*] No shell history, no file persistence"

    # Provide stealth vim launcher
    stealthvim() {
        vim -u NONE -n -N -i NONE -c "set nobackup nowritebackup noswapfile viminfo=" "$@"
    }

    echo "[*] 'stealthvim' available for no-trace file editing."

    # Provide cleanup function
    stealthclean() {
        echo "[*] Cleaning up stealth workspace..."
        cd $HOME || exit 1
        rm -rf "$STEALTHDIR"
        echo "[*] Done. You can now exit safely."
    }

    echo "[*] Run 'stealthclean' when finished to wipe."
}

stealthssh() {
    if [ "$#" -ne 1 ]; then
        echo "Usage: stealthssh user@host"
        return 1
    fi

    echo "[*] Connecting stealthily to $1 ..."
    ssh -q -tt "$1" '
        unset HISTFILE;
        export HISTSIZE=0;
        export HISTFILESIZE=0;
        if command -v setopt >/dev/null 2>&1; then
            setopt NO_HISTORY
        fi;
        BASE_PATH="/dev/shm";
        if [[ "$(uname)" != "Linux" ]]; then BASE_PATH="/tmp"; fi;
        STEALTHDIR=$(mktemp -d "${BASE_PATH}/.XXXXXX");
        chmod 700 "$STEALTHDIR";
        cd "$STEALTHDIR" || exit 1;
        echo "[*] Remote stealthshell ready inside $STEALTHDIR";
        PS1="(stealth) \u@\h:\w\$ ";
        bash --norc
    '
}
